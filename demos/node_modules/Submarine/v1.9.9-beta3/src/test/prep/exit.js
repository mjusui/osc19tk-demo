const assert=require('assert').strict;
closed=[];
process.on('beforeExit', ()=>{
  closed.forEach(
    close => Promise.resolve(close())
      .catch(console.error)
  );
});


closed.push(()=>{
  setTimeout(()=>{
    console.log('a');
  }, 1000);
});

assert.fail('b');

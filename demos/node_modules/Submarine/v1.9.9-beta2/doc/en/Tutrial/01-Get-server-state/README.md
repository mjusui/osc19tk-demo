
# Get server state

You can get hostname, ip addresses, cpu count and mem total from your server currently logged in. Save this code to a file and Run `node /path/to/file`.

```
const Submarine=require('Submarine');

const GetServerState=class extends Submarine {
  query(){
    return {
      hostname: 'hostname -s',

      ip_addrs: String.raw`
        ip -o -f inet a \
          |awk '{print $4}'
      `,

      cpu_count: String.raw`
        cat /proc/cpuinfo \
          |grep '^processor\s*: ' \
          |wc -l
      `,

      mem_kB: String.raw`
         cat /proc/meminfo \
           |grep '^MemTotal: ' \
           |awk '{print $2}'
      `
    };
  }


}


const state=new GetServerState({
  conn: 'bash',
});


state.current()
  .then(console.log);
```

Let us walk through line by line.  
1. `require('Submarine')` imports Submarine Class.
2. `class extends Submarine` defines new Class handed over the features predefined in Submarine Class.
3. `query` is a original thing in GetServerState class and returns a key-value sets. keys are just identifiers. values are commands executed in the target server. In this section, four queries(command) are defined (`hostname -s` and `ip -o -f ...` etc.). Their results(stdout) are the server state you get.
4. `String.raw` means skipping all escapes and therefore leaving the string value as it is. This syntax is a JavaScript feature, preventing some characters, such as `\`, `$`, `'`, `"` etc, from being prefixed by escape character `\`. We recommend using this feature if your command seems too long or includes `line feed` or other characters likely to be escaped.
5. `new GetServerState({ conn: 'bash' })` instantiates your GetServerState Class. `conn` is abbreviation of Connector which means your `query` runs in bash(localhost). `conn` might be `sh`, `bash` and `ssh`. And a `host` option(IP address or hostname) is required when `ssh` is set.
6. `state.current().then` is a real point your queries are executed. `current` means the current state of the target server. And the funciton you passed to `then` is called when all your queries are complete, which is asynchronous.
7. `console.log` outputs the `stats`(key-value sets). keys are the same as defined in `query`. values are the results(stdouts) of the command you defined in `query`. The result could be an Array(ex. [a, b, c]) when the stdout became multi-line.

You can also query to a remote host via ssh (connecting to 127.0.0.1(localhost) instead in this example)

```
const state=new GetServerState({
  conn: 'ssh',
  host: 'server1',
  opt: [
    '-l mjusui',
    '-i /home/mjusui/.ssh/id_rsa',
    '-o ConnectTimeout=10',
  ],
});
```

1. `ssh` is set as connector, so `host` is too set.
2. `opt` is an optional parameter, handed to ssh command with its items concatenated by space `' '` if it is provided as an Array. The case that a String in one line is set to could also occur, in which the String value is evaluated intact as ssh option. And `opt` is at any time followed by two default options `-o StrictHosKeyChecking=no` and `-o ConnectTimeout=4`. These options are ,in ssh syntax, allowed to be specified multiple times and the former is effective. you can consequently override these options only if you explicitly specify them.


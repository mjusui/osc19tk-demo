# Correct server state

we leaned the method above two section of getting and testing server state. Now we set about changing the target server state.

```
const Submarine=require('Submarine');

const CorrectServerState=class extends Submarine {
  query(){
    return {
      file_content: String.raw`
        test -r /tmp/submarine/hogehoge \
          && cat /tmp/submarine/hogehoge \
          || echo 'File not readable' \
            >&2
      `,
    };
  }

  test(stats){
    return {
      file_content_is_hogehoge: stats.file_content === 'hogehoge',
    };
  }

  command(){
    return String.raw`
      mkdir -p /tmp/submarine \
        && echo 'hogehoge' \
          > /tmp/submarine/hogehoge
    `;
  }
 

}


const state=new CorrectServerState({
  conn: 'ssh',
  host: 'server1',
});
    


state.correct()
  .then(console.log);
```


`command` function can be defined returning command as String, executed in the target server to manipulate it. And `state.correct().then` passes an information of command execution, that is like:


1. conn: used connector. ex) 'sh', 'bash', and 'ssh' is available.
2. host: the target server when connecter is ssh. ex) '127.0.0.1' (in this case, the hostname 'server1' is set)
3. cmd: String value returned from `command` function
4. enc: command actually executed
  * All commands are encoded with base64 in Submarine and decoded by `base64 -d` command before executed.  
  This makes you avoid escaping problems in Shell Script.  
6. err: `null` when the command exitted zero status code.
7. stdout: output of the command.
8. stdouts: Array of stdout split by `\n`.
9. stderr: error output of the command.
10. stderrs: Array of stderr split by `\n`.


When `correct` function is executed, first `test` funciton is evaluated, and `command` function is only called when one or more test is failed. When all test is passed, `command` is not executed and `correct().then` casts the result of `check().then`. 

In this sample code, run once this code and 'hogehoge' is written to '/tmp/submarine/hogehoge', then Run again and `test` function has already become to return all true (`/tmp/submarile/hogehoge` is written 'hogehoge' in the former execution), finally `command` call is omitted in any times.

`command` function is to make the target server ideal state. So when the ideal state defined in `test` function is already satisfied, it is not necessary for `command` to be performed.


